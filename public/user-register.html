<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Registration - Shabana</title>
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(145deg, #0a192f, #0f2c45);
      color: #ffffff;
      margin: 0;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at center, rgba(0, 255, 204, 0.05), transparent 60%);
      animation: moveLight 20s linear infinite;
      z-index: 0;
    }

    @keyframes moveLight {
      0% { transform: translate(0%, 0%); }
      50% { transform: translate(25%, 25%); }
      100% { transform: translate(0%, 0%); }
    }

    body > * {
      position: relative;
      z-index: 1;
    }

    .container {
      background: rgba(20, 30, 50, 0.95);
      padding: 30px 20px;
      border-radius: 20px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 0 20px rgba(0, 255, 140, 0.2);
      animation: pulse-glow 3s infinite ease-in-out;
      text-align: center;
      margin: 10px;
    }

    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 0 10px rgba(20, 30, 50, 0.2);
      }
      50% {
        box-shadow: 0 0 20px rgba(84, 110, 168, 0.5);
      }
    }

    .emoji {
      font-size: clamp(32px, 8vw, 48px);
      margin-bottom: 10px;
    }

    h1 {
      color: #00ff84;
      font-size: clamp(20px, 5vw, 26px);
      margin-bottom: 10px;
      line-height: 1.2;
    }

    .subtitle {
      color: #66ffaa;
      font-size: clamp(12px, 3vw, 14px);
      margin-bottom: 25px;
      font-weight: 300;
      line-height: 1.3;
    }

    h3 {
      margin-bottom: clamp(15px, 4vw, 20px);
      font-weight: 400;
      font-size: clamp(18px, 5vw, 22px);
      line-height: 1.2;
      color: #00ff84;
      text-align: center;
    }

    .step-description {
      color: #66ffaa;
      font-size: clamp(14px, 3.5vw, 16px);
      text-align: center;
      margin-bottom: clamp(20px, 5vw, 25px);
    }

    .step {
      margin: 15px 0;
      padding: 25px 15px;
      background-color: rgba(15, 30, 50, 0.9);
      border-radius: 16px;
      display: none;
      border: 1px solid #2b445c;
    }

    .step.active {
      display: block;
    }

    .form-group {
      margin: 20px 0;
    }

    input {
      width: 100%;
      max-width: 300px;
      padding: 14px 12px;
      border: none;
      border-radius: 12px;
      font-size: clamp(14px, 3.5vw, 16px);
      background-color: #102a43;
      color: #ffffff;
      text-align: center;
      min-height: 44px;
      box-sizing: border-box;
    }

    input::placeholder {
      color: #6c89a3;
    }

    button {
      background: linear-gradient(90deg, #00d084, #00ff84);
      color: #fff;
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: clamp(14px, 3.5vw, 16px);
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s ease;
      margin: 8px 5px;
      min-height: 44px;
      box-sizing: border-box;
      white-space: nowrap;
    }

    button:hover {
      transform: scale(1.03);
    }

    button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .warning-button {
      background: linear-gradient(90deg, #ff6b35, #ff8c42);
    }

    .cancel-button {
      background: linear-gradient(90deg, #6c757d, #868e96);
    }

    .whatsapp-button {
      background: linear-gradient(90deg, #25d366, #128c7e);
      color: #fff;
      font-size: clamp(14px, 3.5vw, 16px);
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
    }

    .whatsapp-button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
    }

    .return-button {
      background: linear-gradient(90deg, #007bff, #0056b3);
      color: #fff;
      font-size: clamp(14px, 3.5vw, 16px);
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }

    .return-button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
    }

    .status {
      margin: 20px auto;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: 500;
      text-align: center;
      width: 100%;
      max-width: 100%;
      font-size: clamp(13px, 3vw, 14px);
      line-height: 1.3;
      display: block;
      word-wrap: break-word;
    }

    .success {
      background-color: #1f6f3e;
      border: 1px solid #2ea043;
      color: #d2f4d3;
    }

    .error {
      background-color: #682c2c;
      border: 1px solid #f85149;
      color: #fca5a5;
    }

    .warning {
      background-color: #3d2e00;
      border: 1px solid #f2c94c;
      color: #f1c40f;
    }

    img.google-logo {
      width: clamp(100px, 25vw, 150px);
      height: auto;
      cursor: pointer;
      filter: drop-shadow(0 0 5px #25d366aa);
    }

    .user-exists-message {
      background-color: rgba(255, 107, 53, 0.2);
      border: 2px solid #ff6b35;
      border-radius: 12px;
      padding: 15px;
      margin: 15px 0;
      font-size: clamp(13px, 3vw, 14px);
      line-height: 1.4;
    }

    .gmail-logo-wrapper, .outlook-logo-wrapper {
      width: clamp(70px, 15vw, 100px);
      height: clamp(70px, 15vw, 100px);
      border-radius: 50%;
      background-color: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 10px rgba(0, 255, 140, 0.4);
      transition: transform 0.2s;
      cursor: pointer;
      overflow: hidden;
      margin: 0 auto;
    }

    .gmail-logo-wrapper:hover,
    .outlook-logo-wrapper:hover {
      transform: scale(1.05);
    }

    .email-logo {
      max-width: 80%;
      max-height: 80%;
    }

    .outlook-logo {
      max-width: 60%;
      max-height: 60%;
    }

    .info-box {
      background-color: rgba(0, 255, 132, 0.1);
      border: 1px solid rgba(0, 255, 132, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin: 15px 0;
      color: #66ffaa;
      font-size: clamp(12px, 3vw, 14px);
      line-height: 1.4;
    }

    .admin-info {
      background-color: rgba(255, 165, 0, 0.1);
      border: 1px solid rgba(255, 165, 0, 0.3);
      color: #ffcc66;
    }

    .timer {
      font-size: clamp(16px, 4vw, 18px);
      font-weight: bold;
      color: #00ff84;
      text-align: center;
      margin-top: 15px;
    }

    .verification-code-display {
      background: linear-gradient(45deg, #1a3a5c, #0f2c45);
      border: 2px solid #00ff84;
      border-radius: 15px;
      padding: clamp(15px, 4vw, 25px);
      margin: clamp(15px, 4vw, 25px) 0;
      text-align: center;
      box-shadow: 0 0 15px rgba(0, 255, 132, 0.3);
    }

    .verification-code-display span {
      font-size: clamp(28px, 8vw, 36px);
      font-weight: bold;
      color: #00ff84;
      letter-spacing: clamp(2px, 1vw, 4px);
      font-family: 'Courier New', monospace;
      display: block;
    }

    .code-timer {
      color: #66ffaa;
      font-size: clamp(12px, 3vw, 14px);
      text-align: center;
      margin: 10px 0 20px 0;
    }

    .whatsapp-action {
      text-align: center;
      margin: clamp(20px, 5vw, 30px) 0;
    }

    .system-number {
      color: #66ffaa;
      font-size: clamp(12px, 3vw, 13px);
      margin-top: 8px;
      opacity: 0.8;
    }

    .system-number span {
      font-weight: bold;
      color: #00ff84;
    }

    .manual-instructions {
      text-align: center;
      margin: clamp(15px, 4vw, 20px) 0;
      padding: 10px;
      background-color: rgba(255, 165, 0, 0.1);
      border: 1px solid rgba(255, 165, 0, 0.2);
      border-radius: 8px;
    }

    .instruction-text {
      color: #ffcc66;
      font-size: clamp(12px, 3vw, 13px);
      margin: 0;
      font-style: italic;
    }

    .verification-status {
      text-align: center;
      margin-top: clamp(15px, 4vw, 20px);
    }

    .auto-check {
      color: #66ffaa;
      font-size: clamp(12px, 3vw, 14px);
      margin: 0;
      opacity: 0.8;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    .email-providers-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .email-provider {
      text-align: center;
      flex: 1;
      min-width: 120px;
      max-width: 150px;
    }

    .email-provider p {
      margin-top: 10px;
      color: #00ff84;
      font-size: clamp(13px, 3vw, 14px);
    }

    /* Mobile-specific optimizations */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 20px 15px;
        margin: 5px;
        border-radius: 16px;
      }
      
      .step {
        padding: 20px 12px;
        margin: 10px 0;
      }
      
      .button-group {
        flex-direction: column;
        gap: 10px;
      }
      
      .button-group button {
        width: 100%;
        margin: 5px 0;
      }
      
      .email-providers-container {
        gap: 15px;
      }
      
      .email-provider {
        min-width: 100px;
      }
      
      .gmail-logo-wrapper, .outlook-logo-wrapper {
        width: 80px;
        height: 80px;
      }

      textarea {
        font-size: 13px !important;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: clamp(10px, 3vw, 15px);
        margin: 10px;
      }
      
      .step {
        padding: clamp(12px, 4vw, 15px);
      }
      
      input {
        max-width: 100%;
        padding: 12px 10px;
        font-size: 16px; /* Prevent zoom on iOS */
      }
      
      .verification-code-display {
        padding: 15px;
        margin: 15px 0;
      }
      
      .verification-code-display span {
        font-size: clamp(24px, 10vw, 32px);
        letter-spacing: 2px;
      }
      
      .whatsapp-action {
        margin: 15px 0;
      }
      
      .manual-instructions {
        margin: 12px 0;
        padding: 8px;
      }
      
      .instruction-text {
        font-size: 11px;
      }
      
      .email-providers-container {
        gap: 10px;
        flex-direction: column;
        align-items: center;
      }
      
      .email-provider {
        min-width: 120px;
        max-width: 160px;
      }
      
      .gmail-logo-wrapper, .outlook-logo-wrapper {
        width: 70px;
        height: 70px;
      }

      .info-box {
        padding: 12px;
      }

      .info-box ol, .info-box ul {
        padding-left: 15px;
      }
    }

    /* Landscape mobile optimization */
    @media (max-height: 600px) and (orientation: landscape) {
      body {
        padding: 5px;
      }
      
      .container {
        padding: 15px;
        margin: 5px;
      }
      
      .step {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📧 Email Registration</h1>
    <p class="subtitle">Connect your email to start using the system</p>

    <!-- Step 1: WhatsApp Number Input -->
    <div id="step1" class="step active">
      <h3>Your WhatsApp Number</h3>
      <div class="form-group">
        <input type="tel" id="whatsappNumber" placeholder="e.g., +923001234567" required />
      </div>
      <button id="startBtn" onclick="requestVerification()">Continue</button>
    </div>

    <!-- Step 1.5: WhatsApp Verification -->
    <div id="step1_5" class="step">
      <h3>📱 Verify Your Number</h3>
      
      <div class="verification-code-display">
        <span id="generatedCode">123456</span>
      </div>
      <p class="code-timer">Expires in <span id="verificationTimer">5:00</span></p>
      
      <div class="whatsapp-action">
        <button id="openWhatsAppBtn" class="whatsapp-button" onclick="openWhatsAppWithCode()">
          📱 Send Code
        </button>
        <p class="system-number">Send to: <span id="systemNumber">+923001234567</span></p>
      </div>

      <div class="manual-instructions">
        <p class="instruction-text">Or manually message the code to the number above</p>
      </div>

      <div class="verification-status">
        <p class="auto-check">🔄 Checking automatically...</p>
      </div>
      
      <div id="verificationStatus" class="status" style="display: none;"></div>
    </div>

    <!-- User Exists Confirmation -->
    <div id="userExistsStep" class="step">
      <h3>⚠️ User Already Exists</h3>
      <div class="user-exists-message">
        <p><strong>You have already registered with this number.</strong></p>
        <p>Do you want to register again? This will delete your previous registration data.</p>
      </div>
      <div class="button-group">
        <button class="warning-button" onclick="forceRegister()">Yes, Register Again</button>
        <button class="cancel-button" onclick="cancelRegistration()">No, Cancel</button>
      </div>
    </div>

    <!-- Step 2: Email Authentication -->
    <div id="step2" class="step">
      <h3>📧 Connect Your Email</h3>
      <p class="step-description">Choose your email provider:</p>
      
      <div class="email-providers-container">
        <div class="email-provider">
          <a onclick="authenticateGmail()" style="display:inline-block; margin-top:20px;">
            <div class="gmail-logo-wrapper">
              <img src="/assets/ggl.png" alt="Google Login" class="email-logo" />
            </div>
          </a>
          <p>Gmail</p>
        </div>

        <div class="email-provider">
          <a onclick="authenticateOutlook()" style="display:inline-block; margin-top:20px;">
            <div class="outlook-logo-wrapper">
              <img src="/assets/outlook.png" alt="Outlook Login" class="email-logo outlook-logo" />
            </div>
          </a>
          <p>Outlook</p>
        </div>
      </div>
      
      <div id="emailStatus" class="status success" style="display: none;"></div>
    </div>

    <!-- Step 3: Registration Complete -->
    <div id="step3" class="step">
      <h3>✅ Setup Complete</h3>
      <div id="completionStatus" class="status success"></div>
      
      <!-- Action Buttons -->
      <div id="actionButtons" class="button-group" style="margin-top: 30px; display: none;">
        <button class="whatsapp-button" onclick="startUsingSystem()">
          Start Using System
        </button>
      </div>
      
      <div class="timer" id="timer" style="display: none;"></div>
        <p style="font-size: 12px; color: #ffcc66;">Note: This message will check for pending emails or confirm system readiness 📤</p>
      </div>
    </div>

    <div id="statusMessages" style="text-align:center; width: 100%; margin-top: 15px;"></div>
  </div>

  <script>
    // Configuration - Update this with your backend URL
    const BACKEND_URL = 'https://talkr.paysyslabs.com';
    
    // Listen for messages from the popup window
    window.addEventListener('message', function(event) {
      if (event.data && event.data.status === 'success') {
        console.log(`Received success message from ${event.data.provider} auth window`);
        verifyEmailAuthentication();
      }
    });
    
    let outlookRedirectUri = BACKEND_URL;
    let gmailRedirectUri = BACKEND_URL;

    console.log("👉 BACKEND_URL:", BACKEND_URL);

    // Try to fetch config from backend, fallback to environment variable
    fetch(`${BACKEND_URL}/api/config`)
    // fetch(`${BACKEND_URL}/api/config`, {
    //     method: "GET",
    //   })
      .then(response => response.json())
      .then(config => {
        console.log("Received config:", config);
        outlookRedirectUri = config.config.baseUrl || config.config.server_url || BACKEND_URL;
        gmailRedirectUri = config.config.baseUrl || config.config.server_url || BACKEND_URL;
        console.log("Config loaded - Outlook URI:", outlookRedirectUri, "Gmail URI:", gmailRedirectUri);
      })
      .catch(error => {
        console.error("Failed to fetch config:", error);
        // Use the backend URL from configuration
        outlookRedirectUri = BACKEND_URL;
        gmailRedirectUri = BACKEND_URL;
      });

    let currentStep = 1;
    let userID = '';
    let emailAuthenticated = false;
    let timerInterval;
    let verificationTimerInterval;
    let timeLeft = 3; // Shorter timer for user registration
    let userEmailProvider = ''; // Track the email provider selected by the user
    let verificationId = ''; // Track verification session
    let verificationTimeLeft = 300; // 5 minutes in seconds
    let generatedCode = ''; // Store the generated verification code
    let systemWhatsAppNumber = '+922134327805'; // System's WhatsApp number (admin number)
    let verificationPolling = null; // For auto-polling verification status

    function showStep(step) {
      clearAllIntervals();
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      if (step === 'userExists') {
        document.getElementById('userExistsStep').classList.add('active');
      } else if (step === '1.5') {
        document.getElementById('step1_5').classList.add('active');
        // Start automatic verification polling immediately when verification step is shown
        // This ensures detection works even if user manually sends the code without clicking our button
        setTimeout(() => {
          if (verificationId) {
            startVerificationPolling();
            console.log('🔄 Auto-polling started for verification detection');
          }
        }, 1000); // Small delay to ensure UI is ready
      } else {
        document.getElementById(`step${step}`).classList.add('active');
        currentStep = step;
      }
    }

    function clearAllIntervals() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      if (verificationTimerInterval) {
        clearInterval(verificationTimerInterval);
        verificationTimerInterval = null;
      }
      if (verificationPolling) {
        clearInterval(verificationPolling);
        verificationPolling = null;
      }
    }

    function showStatus(message, type = 'success') {
      const statusDiv = document.getElementById('statusMessages');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
      setTimeout(() => statusDiv.innerHTML = '', 5000);
    }

    function showVerificationStatus(message, type = 'success') {
      const statusDiv = document.getElementById('verificationStatus');
      statusDiv.innerHTML = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      setTimeout(() => statusDiv.style.display = 'none', 5000);
    }

    function startVerificationTimer() {
      verificationTimeLeft = 300; // 5 minutes
      const timerElement = document.getElementById('verificationTimer');
      const generateNewBtn = document.getElementById('generateNewCodeBtn');
      
      verificationTimerInterval = setInterval(() => {
        const minutes = Math.floor(verificationTimeLeft / 60);
        const seconds = verificationTimeLeft % 60;
        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        verificationTimeLeft--;
        
        if (verificationTimeLeft < 0) {
          clearInterval(verificationTimerInterval);
          timerElement.textContent = 'Code Expired';
          generateNewBtn.disabled = false;
          generateNewBtn.textContent = 'Generate New Code';
        }
      }, 1000);
      
      // Enable generate new code button after 2 minutes
      setTimeout(() => {
        generateNewBtn.disabled = false;
        generateNewBtn.textContent = 'Generate New Code';
      }, 120000); // 2 minutes
    }

    function generateVerificationCode() {
      // Generate a random 6-digit code
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    async function requestVerification() {
      const whatsappNumber = document.getElementById('whatsappNumber').value.trim();
      const startBtn = document.getElementById('startBtn');

      if (!whatsappNumber) {
        showStatus('Please enter your WhatsApp number', 'error');
        return;
      }

      if (!whatsappNumber.startsWith('+')) {
        showStatus('Please include country code (e.g., +923001234567)', 'error');
        return;
      }

      startBtn.disabled = true;
      startBtn.textContent = 'Generating Code...';
      userID = whatsappNumber;

      try {
        // Generate verification code locally
        generatedCode = generateVerificationCode();
        
        // Register the verification request with backend
        const response = await fetch(`${BACKEND_URL}/api/register-verification`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            whatsapp_number: whatsappNumber,
            verification_code: generatedCode
          })
        });

        const result = await response.json();
        
        if (result.success) {
          verificationId = result.verification_id;
          
          // Display the code and system number
          document.getElementById('generatedCode').textContent = generatedCode;
          document.getElementById('systemNumber').textContent = systemWhatsAppNumber;
          
          showStatus('Verification code generated!', 'success');
          showStep('1.5');
          startVerificationTimer();
        } else {
          showStatus(`Error: ${result.error}`, 'error');
          startBtn.disabled = false;
          startBtn.textContent = 'Send Verification Code';
        }
      } catch (error) {
        showStatus(`Network error: ${error.message}`, 'error');
        startBtn.disabled = false;
        startBtn.textContent = 'Send Verification Code';
      }
    }

    function openWhatsAppWithCode() {
      const message = encodeURIComponent(generatedCode);
      const phoneNumber = systemWhatsAppNumber.replace('+', '');
      
      // Detect platform for better URL selection (same logic as startUsingSystem)
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isAndroid = /Android/.test(navigator.userAgent);
      
      let primaryUrl, fallbackUrl;
      
      if (isMobile) {
        // Mobile: Prefer app links
        primaryUrl = `whatsapp://send?phone=${phoneNumber}&text=${message}`;
        fallbackUrl = `https://wa.me/${phoneNumber}?text=${message}`;
      } else {
        // Desktop: Use web version
        primaryUrl = `https://web.whatsapp.com/send?phone=${phoneNumber}&text=${message}`;
        fallbackUrl = `https://wa.me/${phoneNumber}?text=${message}`;
      }
      
      // Try to open WhatsApp
      if (isMobile) {
        // Mobile: Try app first, then fallback
        window.location.href = primaryUrl;
        
        // If app doesn't open, try web version after 2 seconds
        setTimeout(() => {
          if (document.hasFocus()) {
            window.open(fallbackUrl, '_blank');
          }
        }, 2000);
      } else {
        // Desktop: Open in new tab
        const newWindow = window.open(primaryUrl, '_blank');
        
        // If that fails, try fallback
        if (!newWindow) {
          setTimeout(() => {
            window.open(fallbackUrl, '_blank');
          }, 500);
        }
      }
      
      // Update UI to show that user should now check verification
      showVerificationStatus('✅ WhatsApp opened! Send the code and then click "Check Verification Status"', 'success');
      
      // Start auto-polling for verification after user opens WhatsApp
      startVerificationPolling();
      
      // Show manual instructions after 3 seconds if still on page
      setTimeout(() => {
        if (document.hasFocus()) {
          showCodeInstructions(phoneNumber, generatedCode);
        }
      }, 3000);
    }

    function showCodeInstructions(phoneNumber, code) {
      // Show manual instructions if automatic redirect fails
      const instructionsHtml = `
        <div class="info-box" style="background-color: rgba(0, 255, 132, 0.1); border-color: rgba(0, 255, 132, 0.3); margin-top: 15px;">
          <p><strong>📱 Manual Verification Steps</strong></p>
          <p>If WhatsApp didn't open automatically:</p>
          <ol style="text-align: left; color: #66ffaa;">
            <li>Open WhatsApp on your device</li>
            <li>Start a chat with: <strong>+${phoneNumber}</strong></li>
            <li>Send this verification code:</li>
          </ol>
          <div style="background: #102a43; padding: 15px; border-radius: 8px; margin: 10px 0;">
            <div style="font-size: 24px; font-weight: bold; color: #00ff84; text-align: center; letter-spacing: 3px; font-family: 'Courier New', monospace;">${code}</div>
          </div>
          <div style="margin-top: 10px;">
            <button onclick="copyToClipboard('${code}')">📋 Copy Code</button>
            <button onclick="openSystemChat()" style="margin-left: 10px;">💬 Open System Chat</button>
          </div>
          <p style="font-size: 12px; color: #66ffaa; margin-top: 15px;">
            💡 After sending the code, click "Check Verification Status" above to continue.
          </p>
        </div>
      `;
      
      // Add instructions to the page
      const statusDiv = document.getElementById('verificationStatus');
      statusDiv.innerHTML = instructionsHtml;
      statusDiv.className = 'status success';
      statusDiv.style.display = 'block';
    }

    function openSystemChat() {
      // Open chat with system number directly
      const phoneNumber = systemWhatsAppNumber.replace('+', '');
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile) {
        window.location.href = `whatsapp://send?phone=${phoneNumber}`;
        setTimeout(() => {
          if (document.hasFocus()) {
            window.open(`https://wa.me/${phoneNumber}`, '_blank');
          }
        }, 2000);
      } else {
        const newWindow = window.open(`https://web.whatsapp.com/send?phone=${phoneNumber}`, '_blank');
        if (!newWindow) {
          window.open(`https://wa.me/${phoneNumber}`, '_blank');
        }
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showVerificationStatus('✅ Copied to clipboard!', 'success');
      }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showVerificationStatus('✅ Copied to clipboard!', 'success');
      });
    }

    async function checkVerificationStatus() {
      const checkBtn = document.getElementById('checkVerificationBtn');
      checkBtn.disabled = true;
      checkBtn.textContent = 'Checking...';

      try {
        const response = await fetch(`${BACKEND_URL}/api/check-verification`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            verification_id: verificationId,
            whatsapp_number: userID
          })
        });

        const result = await response.json();
        
        if (result.success && result.verified) {
          clearInterval(verificationTimerInterval);
          showVerificationStatus('✅ Phone verified successfully!', 'success');
          
          // Complete user registration
          setTimeout(async () => {
            await completeUserRegistration();
          }, 1500);
        } else if (result.success && !result.verified) {
          showVerificationStatus('⏳ Verification pending. Please send the code first.', 'warning');
          checkBtn.disabled = false;
          checkBtn.textContent = 'Check Verification Status';
        } else {
          showVerificationStatus(`❌ ${result.error}`, 'error');
          checkBtn.disabled = false;
          checkBtn.textContent = 'Check Verification Status';
        }
      } catch (error) {
        showVerificationStatus(`Network error: ${error.message}`, 'error');
        checkBtn.disabled = false;
        checkBtn.textContent = 'Check Verification Status';
      }
    }

    async function completeUserRegistration() {
      try {
        // Stop polling since we're completing
        clearInterval(verificationPolling);
        verificationPolling = null;
        
        const response = await fetch(`${BACKEND_URL}/api/complete-verification`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            verification_id: verificationId,
            whatsapp_number: userID,
            email_provider: userEmailProvider
          })
        });

        const result = await response.json();
        
        if (result.success) {
          showVerificationStatus('🎉 Verification completed! Proceeding to email setup...', 'success');
          setTimeout(() => {
            showStep(2); // Go to email authentication
          }, 1500);
        } else {
          showVerificationStatus(`❌ ${result.error}`, 'error');
        }
      } catch (error) {
        showVerificationStatus(`Network error: ${error.message}`, 'error');
      }
    }

    function startVerificationPolling() {
      // Prevent multiple polling intervals
      if (verificationPolling) {
        console.log('🔄 Verification polling already active');
        return;
      }

      console.log('🚀 Starting automatic verification polling...');
      
      // Poll every 3 seconds to check if verification is complete
      verificationPolling = setInterval(async () => {
        try {
          const response = await fetch(`${BACKEND_URL}/api/check-verification`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              verification_id: verificationId,
              whatsapp_number: userID
            })
          });

          const result = await response.json();
          
          if (result.success && result.verified) {
            console.log('🎉 Verification detected automatically!');
            clearInterval(verificationPolling);
            verificationPolling = null;
            clearInterval(verificationTimerInterval);
            
            showVerificationStatus('🎉 Phone verified automatically! Proceeding to email setup...', 'success');
            
            // Complete user registration automatically
            setTimeout(async () => {
              await completeUserRegistration();
            }, 2000);
          } else {
            console.log('⏳ Verification still pending...');
          }
        } catch (error) {
          // Silently continue polling on network errors
          console.log('Polling error (will retry):', error.message);
        }
      }, 3000); // Check every 3 seconds
      
      // Stop polling after 5 minutes (when code expires)
      setTimeout(() => {
        if (verificationPolling) {
          console.log('⏰ Verification polling stopped (5 minute timeout)');
          clearInterval(verificationPolling);
          verificationPolling = null;
        }
      }, 300000); // 5 minutes
    }

    async function generateNewCode() {
      const generateBtn = document.getElementById('generateNewCodeBtn');
      generateBtn.disabled = true;
      generateBtn.textContent = 'Generating...';

      try {
        // Generate new code
        generatedCode = generateVerificationCode();
        
        const response = await fetch(`${BACKEND_URL}/api/regenerate-verification`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            verification_id: verificationId,
            new_verification_code: generatedCode
          })
        });

        const result = await response.json();
        
        if (result.success) {
          document.getElementById('generatedCode').textContent = generatedCode;
          showVerificationStatus('✅ New code generated!', 'success');
          startVerificationTimer(); // Restart timer
        } else {
          showVerificationStatus(`❌ ${result.error}`, 'error');
          generateBtn.disabled = false;
          generateBtn.textContent = 'Generate New Code';
        }
      } catch (error) {
        showVerificationStatus(`Network error: ${error.message}`, 'error');
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate New Code';
      }
    }

    async function startUserRegistration() {
      // This function is now handled by the verification flow
      // Redirect to verification for compatibility
      requestVerification();
    }

    async function forceRegister() {
      const whatsappNumber = document.getElementById('whatsappNumber').value.trim();
      
      try {
        showStatus('Removing previous registration...', 'warning');
        
        const response = await fetch(`${BACKEND_URL}/api/user-force-register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userID, whatsappNumber })
        });

        const result = await response.json();
        if (result.success) {
          showStatus('Previous data removed. Continuing with email...', 'success');
          showStep(2);
        } else {
          showStatus(`Error: ${result.message}`, 'error');
          showStep(1);
          document.getElementById('startBtn').disabled = false;
          document.getElementById('startBtn').textContent = 'Continue to Email';
        }
      } catch (error) {
        showStatus(`Network error: ${error.message}`, 'error');
        showStep(1);
        document.getElementById('startBtn').disabled = false;
        document.getElementById('startBtn').textContent = 'Continue to Email';
      }
    }

    function cancelRegistration() {
      showStep(1);
      document.getElementById('startBtn').disabled = false;
      document.getElementById('startBtn').textContent = 'Continue to Email';
      document.getElementById('whatsappNumber').value = '';
      userID = '';
      showStatus('Registration cancelled', 'warning');
    }

    function authenticateOutlook() {
      console.log("Opening Outlook auth with URI:", outlookRedirectUri);
      const authWindow = window.open(`${outlookRedirectUri}/auth/outlook/${userID}`, 'outlookAuth', 'width=600,height=700,scrollbars=yes,resizable=yes');
      const checkAuth = setInterval(() => {
        try {
          if (authWindow.closed) {
            clearInterval(checkAuth);
            verifyEmailAuthentication();
          }
        } catch (e) {}
      }, 1000);
    }

    function authenticateGmail() {
      const authWindow = window.open(`${gmailRedirectUri}/auth/gmail/${userID}`, 'gmailAuth', 'width=600,height=700,scrollbars=yes,resizable=yes');
      const checkAuth = setInterval(() => {
        try {
          if (authWindow.closed) {
            clearInterval(checkAuth);
            verifyEmailAuthentication();
          }
        } catch (e) {
          console.error("Error checking auth window:", e);
        }
      }, 1000);
    }

    // Keep track of verification attempts
    let verificationAttempts = 0;
    
    async function verifyEmailAuthentication() {
      try {
        console.log("Verifying email authentication for user:", userID);
        verificationAttempts++;
        
        // Give the server some time to process the authentication
        // Use longer delay on subsequent attempts
        const delayMs = verificationAttempts === 1 ? 1000 : 2000;
        console.log(`Waiting ${delayMs}ms before verification attempt ${verificationAttempts}...`);
        await new Promise(resolve => setTimeout(resolve, delayMs));
        
        // Make the API request to check authentication status
        const response = await fetch(`${BACKEND_URL}/api/verify-auth/${userID}`);
        // const response = await fetch(`${BACKEND_URL}/api/verify-auth/${userID}`, {
        //   headers: {
        //     "ngrok-skip-browser-warning": "69420",
        //   },
        // });

        const result = await response.json();
        console.log("Auth verification result:", result);
        
        if (result.success && (result.authenticated || result.emailAuth)) {
          // Authentication successful
          emailAuthenticated = true;
          const provider = result.provider || result.emailProvider || "Email";
          userEmailProvider = provider; // Save the provider for later use
          console.log(`User authenticated with provider: ${provider}`);
          
          // Update UI
          const emailStatus = document.getElementById('emailStatus');
          emailStatus.textContent = `✅ ${provider} authenticated successfully!`;
          emailStatus.className = 'status success';
          emailStatus.style.display = 'block';
          
          // Proceed to next step
          setTimeout(() => {
            showStep(3);
            startCompletionTimer();
          }, 2000);
        } else if (verificationAttempts < 5) {
          // Try again if we haven't exceeded max attempts
          console.log(`Authentication not confirmed yet. Attempt ${verificationAttempts}/5`);
          setTimeout(verifyEmailAuthentication, 2000);
        } else {
          const emailStatus = document.getElementById('emailStatus');
          emailStatus.textContent = '❌ Email authentication failed or was cancelled';
          emailStatus.className = 'status error';
          emailStatus.style.display = 'block';
          setTimeout(() => {
            emailStatus.style.display = 'none';
          }, 3000);
        }
      } catch (error) {
        showStatus(`Error verifying authentication: ${error.message}`, 'error');
      }
    }

    function startCompletionTimer() {
      const completionStatus = document.getElementById('completionStatus');
      completionStatus.textContent = '✅ Email authenticated successfully!';
      document.getElementById('timer').style.display = 'block';

      timerInterval = setInterval(() => {
        document.getElementById('timer').textContent = `Setting up your account in ${timeLeft} seconds...`;
        timeLeft--;
        if (timeLeft < 0) {
          clearInterval(timerInterval);
          finishUserRegistration();
        }
      }, 1000);
    }

    async function finishUserRegistration() {
      clearInterval(timerInterval);
      try {
        // Use the saved provider if available, otherwise get the latest from the server
        let emailProvider = userEmailProvider;
        
        if (!emailProvider) {
          console.log('No saved provider, fetching from server...');
          const authResponse = await fetch(`${BACKEND_URL}/api/verify-auth/${userID}`);
          const authResult = await authResponse.json();
          emailProvider = authResult.provider || authResult.emailProvider || 'outlook';
        }
        
        console.log(`Completing registration with provider: ${emailProvider}`);
        
        const response = await fetch(`${BACKEND_URL}/api/user-complete-registration`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            userID,
            emailProvider 
          })
        });
        const result = await response.json();
        if (result.success) {
          // Update completion status
          document.getElementById('completionStatus').textContent = '🎉 User registration completed successfully!';
          document.getElementById('timer').style.display = 'none';
          
          // Show action buttons with a short delay for better UX
          setTimeout(() => {
            const actionButtons = document.getElementById('actionButtons');
            actionButtons.style.display = 'flex';
            console.log('Action buttons displayed');
            
            // Add a subtle highlight effect
            actionButtons.style.animation = 'pulse-glow 2s ease-in-out';
          }, 1000);
          
          // Optional: Auto-redirect after longer period (60 seconds instead of 30)
          setTimeout(() => {
            showStatus('Auto-redirecting to registration page in 5 seconds...', 'warning');
            setTimeout(() => {
              window.location.reload();
            }, 5000);
          }, 60000);
        } else {
          showStatus(`Error: ${result.message}`, 'error');
          console.error('Registration completion failed:', result);
        }
      } catch (error) {
        showStatus(`Error: ${error.message}`, 'error');
        console.error('Registration completion error:', error);
        
        // Show action buttons anyway if there's an error, so user isn't stuck
        setTimeout(() => {
          document.getElementById('actionButtons').style.display = 'flex';
          showStatus('Registration may have completed. Try using the system or return to registration.', 'warning');
        }, 2000);
      }
    }

    function startUsingSystem() {
      // Create a functional message that will trigger system interaction
      const introMessage = `Shabana Email-WhatsApp is live! 🚀 Launch my email agent or confirm we're clear for takeoff. 📧✨`;

      // Show info about what's happening
      document.getElementById('whatsappInfo').style.display = 'block';
      showStatus('Opening admin chat to start using the system...', 'success');
      
      const phoneNumber = '922134327805';
      const encodedMessage = encodeURIComponent(introMessage);
      
      // Detect platform for better URL selection
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isAndroid = /Android/.test(navigator.userAgent);
      
      let primaryUrl, fallbackUrl;
      
      if (isMobile) {
        // Mobile: Prefer app links
        primaryUrl = `whatsapp://send?phone=${phoneNumber}&text=${encodedMessage}`;
        fallbackUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
      } else {
        // Desktop: Use web version
        primaryUrl = `https://web.whatsapp.com/send?phone=${phoneNumber}&text=${encodedMessage}`;
        fallbackUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
      }
      
      // Try to open WhatsApp
      if (isMobile) {
        // Mobile: Try app first, then fallback
        window.location.href = primaryUrl;
        
        // If app doesn't open, try web version after 2 seconds
        setTimeout(() => {
          if (document.hasFocus()) {
            window.open(fallbackUrl, '_blank');
          }
        }, 2000);
      } else {
        // Desktop: Open in new tab
        const newWindow = window.open(primaryUrl, '_blank');
        
        // If that fails, try fallback
        if (!newWindow) {
          setTimeout(() => {
            window.open(fallbackUrl, '_blank');
          }, 500);
        }
      }
      
      // Show manual instructions after 3 seconds if still on page
      setTimeout(() => {
        if (document.hasFocus()) {
          showSystemInstructions(phoneNumber, introMessage);
        }
      }, 3000);
    }
    
    function showSystemInstructions(phoneNumber, message) {
      // Show manual instructions if automatic redirect fails
      const instructionsHtml = `
        <div class="info-box" style="background-color: rgba(0, 255, 132, 0.1); border-color: rgba(0, 255, 132, 0.3);">
          <p><strong>📱 Check Your Email Queue</strong></p>
          <p>To start using the email system through WhatsApp:</p>
          <ol style="text-align: left; color: #66ffaa;">
            <li>Open WhatsApp on your device</li>
            <li>Start a chat with the admin: <strong>+${phoneNumber}</strong></li>
            <li>Send this message to check for emails:</li>
          </ol>
          <textarea readonly style="width: 100%; height: 120px; margin: 10px 0; padding: 10px; background: #102a43; color: #fff; border: 1px solid #2b445c; border-radius: 8px; font-size: 14px;">${message}</textarea>
          <div style="margin-top: 10px;">
            <button onclick="copyToClipboard(\`${message.replace(/`/g, '\\`')}\`)">📋 Copy Message</button>
            <button onclick="openAdminChat()" style="margin-left: 10px;">💬 Open Admin Chat</button>
          </div>
          <p style="font-size: 12px; color: #66ffaa; margin-top: 15px;">
            💡 <strong>Expected Response:</strong> System will either show pending emails or confirm it's ready for new emails!
          </p>
        </div>
      `;
      
      document.getElementById('whatsappInfo').innerHTML = instructionsHtml;
    }
    
    function openAdminChat() {
      // Simple direct link to admin chat without message
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile) {
        window.location.href = 'whatsapp://send?phone=922134327805';
      } else {
        window.open('https://web.whatsapp.com/send?phone=922134327805', '_blank');
      }
      
      showStatus('Admin chat opened! Please paste your introduction message.', 'success');
    }
    
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showStatus('Introduction message copied! 📋', 'success');
      }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showStatus('Introduction message copied! 📋', 'success');
      });
    }

    function returnToRegistration() {
      showStatus('Returning to registration page...', 'success');
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    }

    window.addEventListener('beforeunload', () => {
      clearAllIntervals();
    });
  </script>
</body>
</html>
